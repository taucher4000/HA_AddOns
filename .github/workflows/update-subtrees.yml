name: Update HA subtrees (cron)

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  update-subtrees:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          persist-credentials: false

      - name: Configure git
        run: |
          git config user.name "subtree-bot"
          git config user.email "subtree-bot@users.noreply.github.com"

      - name: Save current HEAD
        run: |
          echo "OLD_HEAD=$(git rev-parse HEAD)" >> $GITHUB_ENV


      - name: Update HA_InetBox (main)
        run: |
          git subtree pull \
            --prefix=ha_inetbox \
            https://github.com/taucher4000/HA_InetBox.git \
            main \
            --squash \
            -m "Automated subtree update"

      - name: Update HA_InetBox (testing)
        run: |
          git subtree pull \
            --prefix=ha_inetbox_beta \
            https://github.com/taucher4000/HA_InetBox.git \
            testing \
            --squash \
            -m "Automated subtree update"

      - name: Push subtree updates if there are changes
        run: |
          NEW_HEAD=$(git rev-parse HEAD)
          if [ "$OLD_HEAD" != "$NEW_HEAD" ]; then
            echo "Subtree changes detected, pushing..."
            git push https://x-access-token:${{ secrets.HA_ADDONS_SUBTREE_UPDATE }}@github.com/taucher4000/HA_AddOns.git main
          else
            echo "No subtree changes, nothing to push."
          fi