name: Update HA subtrees (cron)

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  update-subtrees:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Configure git
        run: |
          git config user.name "subtree-bot"
          git config user.email "subtree-bot@users.noreply.github.com"

      - name: Update HA_InetBox (main)
        run: |
          git subtree pull \
            --prefix=ha_inetbox \
            https://github.com/taucher4000/HA_InetBox.git \
            main \
            --squash

      - name: Update HA_InetBox (testing)
        run: |
          git subtree pull \
            --prefix=ha_inetbox_beta \
            https://github.com/taucher4000/HA_InetBox.git \
            testing \
            --squash

      - name: Update HA_CANBus (main)
        run: |
          git subtree pull \
            --prefix=ha_canbus \
            https://github.com/taucher4000/HA_CANBus.git \
            main \
            --squash

      - name: Push subtree updates
        run: |
          git -c http.extraheader="Authorization: Bearer ${{ secrets.HA_ADDONS_SUBTREE_UPDATE }}" push origin main
